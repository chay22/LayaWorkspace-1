function sendScore(e){wx.setUserCloudStorage({KVDataList:[{key:"rankScore",value:e}],success:function(e){console.log("发送成功")},fail:function(e){console.log("发送失败")},complete:function(e){}})}function getRankPage(e){0==e?(rankPageIndex=0,getFriendRank()):1==e?(console.log("下一页"),(rankPageIndex+1)*RANKITEMNUM<dataList.length&&rankPageIndex++,getPageDataList()):-1==e&&(console.log("上一页"),0==rankPageIndex?rankPageIndex=0:rankPageIndex--,getPageDataList())}function getFriendRank(){wx.getFriendCloudStorage({keyList:["rankScore"],success:function(e){console.log("获取好友排行成功"),dataList=e.data,console.log("好友排行数量="+dataList.length),dataList.sort(compareScore),getPageDataList()},fail:function(e){console.log("获取好友排行失败")},complete:function(e){}})}function compareScore(e,a){var n=e.KVDataList[0].value,t=a.KVDataList[0].value;return console.log("------------排行对比--tempA="+n+",tempB="+t),t-n}function getPageDataList(){var e=rankPageIndex*RANKITEMNUM,a=e+RANKITEMNUM;dataList.length<a&&(a=dataList.length),infoList=[];for(var n=e;n<a;n++)console.log("----showindex="+n),infoList.push(dataList[n]);drawRankList(infoList)}function drawRankList(e){e.forEach(function(e,a){var n=e;console.log("index="+a+",名称="+n.nickname),console.log("url="+n.avatarUrl);var t=n.KVDataList;console.log("score="+t[0].value),drawUserInof(a,e)})}function drawUserInof(e,a){drawRenderIcon(e,a.avatarUrl),drawRenderNickName(e,a.nickname),drawRenderScore(e,a.KVDataList[0].value)}function drawRenderIcon(e,a){var n=wx.createImage();n.src=a,n.onerror=function(){console.log("头像加载失败:"+a)};var t=centenrX-70,o=centenrY+e*ICON_GAP;if(n.onload=function(){sharedContext.drawImage(n,t,o,ICON_SIZE,ICON_SIZE)},0==rankPageIndex){var r=wx.createImage();r.src="game/img_di"+(e+1)+".png";var s=t-37,c=o;r.onload=function(){sharedContext.drawImage(r,s,c,31,34.5)}}else{sharedContext.fillStyle="#000000",sharedContext.font="16px Arial";var i=t-25,d=o+20,l=rankPageIndex*RANKITEMNUM+e+1+"";sharedContext.fillText(l,i,d)}}function drawRenderNickName(e,a){sharedContext.fillStyle="#000000",sharedContext.font="12px Arial";var n=centenrX-30,t=centenrY+e*ICON_GAP+20;a.length>5?sharedContext.fillText(a.slice(0,5)+"...",n,t):sharedContext.fillText(a,n,t)}function drawRenderScore(e,a){sharedContext.fillStyle="#000000",sharedContext.font="14px Arial";var n=centenrX+50,t=centenrY+e*ICON_GAP+20;sharedContext.fillText(a,n,t)}var sharedCanvas,sharedContext,dataList,rankType,img,currentLoadHeadCnt=0,infoList=[],centenrX=0,centenrY=0,rankPageIndex=0,STAST_HEIGHT=10,RANK_WIDTH=.1,HEAD_ICON_WIDTH=.25,NICK_NAME_WIDTH=.42,COUNT_WIDTH=.85,SPACE_HEIGHT=30,ICON_SIZE=30,ICON_GAP=ICON_SIZE+15,RANKITEMNUM=3,FRIEND=1,GROUP=2,SCORE=3;wx.onMessage(function(e){console.log("收到主域消息:"+e),sharedCanvas=wx.getSharedCanvas(),sharedContext=sharedCanvas.getContext("2d"),centenrX=sharedCanvas.width/2,centenrY=sharedCanvas.height/2+30,sharedContext.clearRect(0,0,sharedCanvas.width,sharedCanvas.height),sharedContext.fillStyle="red",e.msgType==FRIEND?(console.log("好友排行"),getRankPage(e.page)):e.msgType==GROUP||e.msgType==SCORE&&sendScore(e.score+""),console.log("执行onMessage结束:")});